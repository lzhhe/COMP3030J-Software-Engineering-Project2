{% extends 'individual/base.html' %}
{% block extra_css %}
    <style>

        .header .container {
            border-bottom: 0.12rem solid var(--border-color);

        }

        .individual-create {
            display: grid;
            grid-template-columns: 1fr 1fr;
            position: relative;
            padding: 7.5rem 3rem 4rem;
            gap: 0.8rem;
            background: var(--panel2-color);
        }

        .individual-create-module {
            display: flex;
            flex-direction: column;
            border-radius: 0.6rem;
            background: var(--panel-color);
            box-shadow: 1.5px 1.2px 5.3px rgba(0, 0, 0, 0.02),
            5.5px 4.4px 17.9px rgba(0, 0, 0, 0.034),
            43px 35px 80px rgba(0, 0, 0, 0.07);
        }

        .title-top {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            border-bottom: 0.12rem solid var(--border-color);
        }

        .icons {
            width: 2rem;
            margin-right: 1.5rem;
        }

        .form-container {
            padding: 1rem 2rem;
        }

        .pico label.no-pico-label {
            display: flex;
            align-items: center;
        }

        .pico input[type="number"] {
            width: 12rem;
            margin-left: 1rem;
        }

        .order-attributes {
            display: flex;
            flex-direction: row;
            gap: 0.6rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .order-choose {
            display: flex;
            align-items: center;
            gap: 5rem;
        }

        .dropdown {
            width: 25rem;
        }

        .dropdown li a {
            display: flex;
            flex-direction: row;
        }

        .dropdown li a i {
            display: inline;
            margin-left: 1rem;
            margin-right: 1.5rem;
            font-size: 1.2rem;
        }

        .dropdown li:hover i,
        .dropdown li:hover span {
            color: var(--primary-color);
        }

        .pico .no-pico-label input[type="text"] {
            width: 10rem;
            margin-left: 1rem;
        }

        .pico label.no-pico-label i {
            font-size: 1.5em;
        }

        .pico label.no-pico-label span {
            margin-left: 0.5rem;
        }

        .pico label.no-pico-label:hover i, .pico label.no-pico-label:hover span {
            color: var(--primary-color);
        }

        #location-container {
            width: 90%;
        }

        #location-map {
            width: 40rem;
            height: 30rem;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
        }
    </style>
{% endblock %}
{% block extra_js %}
    <script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?key={{ a3 }}' async defer></script>
{% endblock %}
{% block title %}
    indi-create
{% endblock %}
{% block content %}
    {% include 'switch2.html' %}
    {% include 'aichat.html' %}
    {% include 'header2.html' %}
    <section class="individual-create">
        <div class="individual-create-module">
            <div class="title-top">
                <img src="../../static/image/icon/order.svg" alt="home" class="icons icon-nav"
                     title="Scene">
                <h2>{{ _("Create Order") }}</h2>
            </div>
            <div class="form-container">
                <form class="pico" id="orderForm" method="post" action="/department/createorder">
                    <label for="order-name">{{ _("Order name:") }}
                        <input type="text" id="order-name" name="order-name" required>
                    </label>
                    <div class="order-choose">
                        <details class="pico dropdown" data-value="">
                            <summary>{{ _("Please choose one waste type: ") }}</summary>
                            <ul>
                                {% for waste in wastes %}
                                    <li data-value="{{ waste }}">
                                        <a href="#">
                                            <i class="iconfont icon-{{ waste.name }}"></i>
                                            <span>{{ waste|enum_to_string }}</span></a></li>
                                {% endfor %}
                            </ul>
                        </details>
                        <label class="number-input no-pico-label" for="order-weight">{{ _("Weight: ") }}
                            <input type="number" id="order-weight" name="order-weight" required>
                            <span>kg</span>
                        </label>
                    </div>
                    {{ _("Attributes:") }}
                    <div class="order-attributes">
                        <label class="number-input no-pico-label order-attribute" for="order-a1">
                            <input type="text" id="order-a1" name="order-a1" required data-attr="CO2">
                            <span>CO2</span>
                        </label>
                        <label class="number-input no-pico-label order-attribute" for="order-a2">
                            <input type="text" id="order-a2" name="order-a2" required data-attr="J">
                            <span>J</span>
                        </label>
                        <label class="number-input no-pico-label order-attribute" for="order-a3">
                            <input type="text" id="order-a3" name="order-a3" required data-attr="SO2">
                            <span>SO2</span>
                        </label>
                        <label class="number-input no-pico-label order-attribute" for="order-a4">
                            <input type="text" id="order-a4" name="order-a4" required data-attr="SO4">
                            <span>SO4</span>
                        </label>
                        <label class="number-input no-pico-label order-attribute" for="order-a5">
                            <input type="text" id="order-a5" name="order-a5" required data-attr="SO4">
                            <span>SO4</span>
                        </label>
                        <label class="number-input no-pico-label order-attribute" for="order-a6">
                            <input type="text" id="order-a6" name="order-a6" required data-attr="SO4">
                            <span>SO4</span>
                        </label>
                    </div>
                    <div id="location-container">
                        <label for="order-comment">{{ _("Your address:") }}
                            <input type="text" id="order-comment" name="order-comment">
                        </label>
                    </div>
                    <div id="location-map" style="margin-left: auto; margin-right: auto"></div>
                    <input type="button" id="createOrderBtn" class="outline" value="{{ _("Create") }}"></input>
                </form>
            </div>
        </div>
        <div class="individual-create-module">
            <div class="title-top">
                <img src="../../static/image/icon/order.svg" alt="home" class="icons icon-nav"
                     title="Scene">
                <h2>{{ _("Create Order") }}</h2>
            </div>
        </div>
    </section>
    <a href="#top" class="back-top-btn" aria-label="Back to top" data-back-top-btn>
        <i class="iconfont icon-top"></i>
    </a>
    {% include 'footer2.html' %}
    <script>

        function loadMapScenario() {
            let initialLocation;
            let map = new Microsoft.Maps.Map(document.getElementById('location-map'), {
                credentials: '{{ a3 }}',
                zoom: 20,
                showMapTypeSelector: false, // Hide map type selector
                disableZooming: false,       // Disable zooming
                showZoomButtons: false      // Hide zoom buttons
            });
            let loc; // 用于存储当前或选择的位置
            let currentZoom = 20; // 存储当前缩放级别
            // 加载AutoSuggest和Search模块
            Microsoft.Maps.loadModule(['Microsoft.Maps.AutoSuggest', 'Microsoft.Maps.Search'], function () {
                let manager = new Microsoft.Maps.AutosuggestManager({map: map});
                manager.attachAutosuggest('#order-comment', '#location-container', selectedSuggestion);
                let searchManager = new Microsoft.Maps.Search.SearchManager(map);

                // 定义选中建议后的行为
                function selectedSuggestion(suggestionResult) {
                    loc = suggestionResult.location;
                    updateMapLocation(loc);
                }

                // 获取当前位置并更新地图
                navigator.geolocation.getCurrentPosition(function (position) {
                    initialLocation = new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude);
                    loc = new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude);
                    updateMapLocation(loc, true); // 初始定位
                });

                function updateMapLocation(location, initial = false) {
                    currentZoom = map.getZoom(); // 否则保持当前缩放级别
                    map.entities.clear();
                    map.setView({location: location, zoom: currentZoom});
                    let pushpin = new Microsoft.Maps.Pushpin(location);
                    map.entities.push(pushpin);
                    // 逆地理编码获取地址，并确保搜索结果为当前视图中心
                    searchManager.reverseGeocode({
                        location: location,
                        callback: function (result) {
                            if (result.name) {
                                document.getElementById('order-comment').value = result.name;
                                if (!initial) {
                                    // 确保搜索框中的结果更新为当前位置
                                    map.setView({center: location, zoom: currentZoom});
                                }
                            }
                        }
                    });
                }

// 点击地图获取新位置时，不重新设定视图中心
                Microsoft.Maps.Events.addHandler(map, 'click', function (e) {
                    if (e.location) {
                        updateMapLocation(e.location, true);
                    }
                });

// “定位到我”按钮逻辑，确保返回初始位置时视图中心和缩放级别一致
                $('#LocateMeButton').click(function (e) {
                    e.preventDefault();
                    updateMapLocation(initialLocation, true);
                });


            });
        }

        window.onload = loadMapScenario;
        $('.header__logo').click(function (e) {
            e.preventDefault();
            window.location.href = '/individual/index';
        });

        window.addEventListener('beforeunload', function (event) {
            console.log('页面关闭，清理不需要的缓存');
        });
    </script>


{% endblock %}